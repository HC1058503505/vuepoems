<template lang="wxml">
    <view class="avatar_container">
        <image class="avatar_icon" src="{{avatar}}" mode="aspectFill"
      lazy-load="false">
        </image>

        <button class="login_btn" wx:if="{{hideLogBtn}}" type="info" open-type="getUserInfo" bindgetuserinfo="tapLogin">
            {{logBtnTitle}}
        </button>
        <view class="nickname_label" wx:if="{{!hideLogBtn}}">{{nickName}}</view>
    </view>

    <view class="section_list_container">
        <view class="section_cell" @tap="showMore('mine_collection')">
            <image class="section_icon" src="../images/yes_collection.png" mode="aspectFill"
              lazy-load="false">
            </image>
            <view class="section_title">我的收藏</view>
        </view>
        <view class="section_cell" @tap="showMore('browse_histories')">
            <image class="section_icon" src="../images/liulanjilu.png" mode="aspectFill"
              lazy-load="false">
            </image>
            <view class="section_title">浏览记录</view>
        </view>
    </view>
</template>


<script>
import wepy from 'wepy'

export default class Me extends wepy.page{
    config = {
      navigationBarTitleText: '我'
    }

    data = {
        avatar: '../images/shi.png',
        hideLogBtn: true,
        logBtnTitle: '点击登录',
        loginTimer: null,
        nickName: '',
    }

    methods = {
        showMore(typeStr) {
            if (wepy.$instance.globalData.userInfo == null) {
                this.logBtnTitle = '请您先登录'
                let that = this
                this.loginTimer = setTimeout(() => {
                    that.logBtnTitle = '点击登录'
                    that.$apply()
                }, 2000);
                
                return
            }
            wepy.navigateTo({ url: '/pages/collectionhistory?type=' + typeStr });
        },

        tapLogin (res) {
            if (!res.detail.userInfo || !res.detail.signature) {
                return
            }
            this.hideLogBtn = false
            this.avatar = res.detail.userInfo.avatarUrl
            this.nickName = res.detail.userInfo.nickName
            wepy.$instance.globalData.userInfo = res.detail
            wepy.$instance.getOpenId()
        }
    }

    onShow () {

    }

    onUnload () {
        if (this.loginTimer) {
            clearTimeout(this.loginTimer)
        }
    }
    onLoad () {
        if (wepy.$instance.globalData.userInfo) {
            this.hideLogBtn = false
            this.avatar = wepy.$instance.globalData.userInfo.userInfo.avatarUrl
            this.nickName = wepy.$instance.globalData.userInfo.userInfo.nickName
        } else {
            this.hideLogBtn = true
        }
    }
}
</script>

<style lang="less" scoped>
.avatar_container {
    text-align: center;
    .avatar_icon {
        height: 100px;   
        width: 100px;
    }
    .login_btn {
        margin-top: 10px;
        width: 100px;
        font-size: 14px;
        height: 35px;;
    }
    .nickname_label {
        margin-top: 10px;
        height: 35px;
    }
}

.section_list_container {
    padding-top: 80px;
    padding-left: 15px;
    padding-right: 15px;
    
    .section_cell {
        display: flex;
        display: -webkit-flex;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
        margin-bottom: 15px;
        border-bottom: gainsboro 1px solid;
        .section_icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        .section_title {
            font-size: 15px;
        }
    }
}
</style>
